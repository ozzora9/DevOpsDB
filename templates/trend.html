{% extends "base.html" %}
{% block title %}íŠ¸ë Œë“œ - ColorWalk{% endblock %}
{% block body_class %}trend-page{% endblock %}
{% block main_class %}trend-container{% endblock %}
{% block content %}

<!-- ğŸ—ºï¸ ì§€ë„ í‘œì‹œ ì˜ì—­ -->
<section class="trend-map">
  <div class="map-header">
    <h2>ğŸ“ ìƒ‰ìƒë³„ ì—…ë¡œë“œ ìœ„ì¹˜ ì§€ë„</h2>
    <p class="sub">ê° ìƒ‰ìƒì— í•´ë‹¹í•˜ëŠ” ë§ˆì»¤ë¡œ ì‚¬ì§„ì˜ ì´¬ì˜ ìœ„ì¹˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
    
    <!-- ğŸ”˜ ì „ì²´ / ë‚´ ì‚¬ì§„ ë³´ê¸° ë²„íŠ¼ -->
    <div class="map-buttons">
      <button id="showAll" class="active">ì „ì²´ ì‚¬ì§„ ë³´ê¸°</button>
      <button id="showMine">ë‚´ ì‚¬ì§„ë§Œ ë³´ê¸°</button>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
  </div>
</section>

<!-- Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<style>
  .trend-map {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .map-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .map-header h2 {
    font-size: 1.8rem;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .map-header .sub {
    color: #666;
    font-size: 1rem;
    line-height: 1.5;
  }

  .map-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  .map-buttons button {
    background: #f0f0f0;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  .map-buttons button:hover {
    background: #ddd;
  }

  .map-buttons button.active {
    background: #339af0;
    color: #fff;
  }

  /* ğŸ—ºï¸ ì§€ë„ ì˜ì—­ */
  .map-wrap {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  #map {
    width: 70vw;
    max-width: 1000px;
    min-width: 320px;
    height: 75vh;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    margin: 0 auto;
    transition: width 0.3s ease;
  }

  @media (max-width: 1024px) {
    #map { width: 80vw; }
  }

  @media (max-width: 768px) {
    #map { width: 90vw; height: 65vh; }
  }
</style>

<script>
  const photos = {{ photos | tojson }};
  const myPhotos = {{ my_photos | tojson }};

  const colorKeyMap = {
    1: "red", 2: "orange", 3: "yellow", 4: "green", 5: "blue",
    6: "purple", 7: "brown", 8: "black", 9: "white",
  };

  const colorHex = {
    red: "#FF4B5C", orange: "#FF8C42", yellow: "#FFD93D",
    green: "#4CAF50", blue: "#4A90E2", purple: "#A66DD4",
    brown: "#8B5E3C", black: "#222222", white: "#FFFFFF"
  };

  // ğŸ“ ìƒ‰ìƒë³„ ë§ˆì»¤ ìƒì„±
  function getMarkerIcon(colorKey) {
    const fill = colorHex[colorKey] || "#888888";
    const stroke = colorKey === "white" ? "#888" : "#FFF";
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="40" viewBox="0 0 24 24">
        <path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.42-3.58-8-8-8z"
              fill="${fill}" stroke="${stroke}" stroke-width="1.2"/>
        <circle cx="12" cy="10" r="2.4" fill="#ffffff" opacity="0.9"/>
      </svg>`;
    const url = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    return L.icon({
      iconUrl: url,
      iconSize: [28, 40],
      iconAnchor: [14, 40],
      popupAnchor: [0, -36]
    });
  }

  // ğŸ—ºï¸ ì§€ë„ ìƒì„±
  const map = L.map("map", { zoomControl: true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  let markers = [];

  // ê³µí†µ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
  function showMarkers(data) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    const bounds = L.latLngBounds();

    data.forEach(p => {
      const lat = p.lat ?? 37.5665;
      const lon = p.lon ?? 126.9780;
      const colorKey = colorKeyMap[p.color_id] || "gray";

      const marker = L.marker([lat, lon], {
        icon: getMarkerIcon(colorKey)
      }).addTo(map);

      bounds.extend([lat, lon]);
      marker.bindPopup(`
  <div style="text-align:center">
    <img src="${p.image_path}" width="120" style="border-radius:8px; margin-bottom:6px"><br>
    <b>${colorKey}</b> ê³„ì—´<br>
    <small>ğŸ“¸ ${p.username || 'ìµëª… ì‚¬ìš©ì'}</small>
  </div>
`);

      markers.push(marker);
    });

    if (data.length > 0)
      map.fitBounds(bounds, { padding: [30, 30], maxZoom: 13 });
    else
      map.setView([37.5665, 126.9780], 12);
  }

  // ğŸ§­ ê¸°ë³¸: ì „ì²´ ì‚¬ì§„ í‘œì‹œ
  showMarkers(photos);

  // ë²„íŠ¼ ì œì–´
  const btnAll = document.getElementById("showAll");
  const btnMine = document.getElementById("showMine");

  btnAll.addEventListener("click", () => {
    btnAll.classList.add("active");
    btnMine.classList.remove("active");
    showMarkers(photos);
  });

  btnMine.addEventListener("click", () => {
    btnMine.classList.add("active");
    btnAll.classList.remove("active");

    if (myPhotos.length > 0) {
      showMarkers(myPhotos);
    } else {
      markers.forEach(m => map.removeLayer(m));
      alert("âš ï¸ ë‚´ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. (ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì—…ë¡œë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.)");
    }
  });

  setTimeout(() => map.invalidateSize(), 100);
</script>

{% endblock %}